{% extends "main.html" %}
{% block content %}
    <div class="borrowing_extention">
        <form action="" method="POST" class="borrowing_extention-form">
            {% csrf_token %}
            <label for="stock_num">מק''ט הפריט</label>
            <input type="text"
                   id="stock_num"
                   name="stock_num"
                   value="{{ borrowing.product.stock_num }}"
                   readonly>
            <label for="product_name">שם הפריט</label>
            <input type="text"
                   id="product_name"
                   name="product_name"
                   value="{{ borrowing.product.name }}"
                   readonly>
            <label for="exp_date_to_borrow">תאריך השאלה רצוי</label>
            <input type="datetime-local"
                   value="{input_value}"
                   min="{min_value}"
                   max="{max_value}"
                   id="exp_date_to_borrow"
                   name="exp_date_to_borrow"
                   required>
            <label for="exp_date_to_return">תאריך החזרה רצוי</label>
            <input type="datetime-local"
                   id="exp_date_to_return"
                   name="exp_date_to_return"
                   disabled
                   required>
            <label for="comments">הערות</label>
            <input type="text" id="comments" name="comments">
            <div>
                <input type="submit" value="שלח/י">
            </div>
        </form>
    </div>

    <script>
        const expDateToBorrow = document.getElementById('exp_date_to_borrow');
        const expDateToReturn = document.getElementById('exp_date_to_return');

        function roundMinutes(date) {
            const minutes = date.getMinutes();
            const roundedMinutes = Math.ceil(minutes / 10) * 10;
            date.setMinutes(roundedMinutes);
            return date;
        }

        function getLocalDateTimeString(date) {
            const offset = date.getTimezoneOffset() * 60000;
            const localDate = new Date(date.getTime() - offset);
            return localDate.toISOString().slice(0, -8);
        }

        expDateToBorrow.addEventListener('input', function() {
            const selectedDate = new Date(expDateToBorrow.value);
            const roundedDate = roundMinutes(selectedDate);
            expDateToBorrow.value = getLocalDateTimeString(roundedDate);

            expDateToReturn.disabled = false;

            const min = new Date(roundedDate);
            const max = new Date(roundedDate);
            min.setHours(min.getHours() + 1);
            max.setDate(max.getDate() + 7);
            expDateToReturn.min = getLocalDateTimeString(min);
            expDateToReturn.max = getLocalDateTimeString(max);
            expDateToReturn.value = expDateToReturn.min;
        });

        expDateToReturn.addEventListener('input', function() {
            const selectedDate = new Date(expDateToReturn.value);
            const min = new Date(expDateToReturn.min);
            const max = new Date(expDateToReturn.max);
            if (selectedDate <= min) {
                expDateToReturn.value = getLocalDateTimeString(min);
                return;
            }
            if (selectedDate > max) {
                expDateToReturn.value = getLocalDateTimeString(max);
                return;
            }
            const roundedDate = roundMinutes(selectedDate);
            expDateToReturn.value = getLocalDateTimeString(roundedDate);
        });
    </script>
{% endblock content %}
